require 'net/http'

class HomeController < ApplicationController
  def search
  end

  def get_detail

    b = Hash.new
  	location = params[:location]
    page = params[:page]
  	location = location.gsub(" ","_")
  	url = "/wiki/en/api.php?action=query&prop=revisions&rvprop=content&rvsection=#{page}&titles=#{location}&format=xml&rvparse"
    # http://wikitravel.org/wiki/en/api.php?action=query&prop=revisions&rvprop=content&rvsection=3&titles=Rio_de_Janeiro&format=xml&rvparse
    response = Net::HTTP.get_response("wikitravel.org", url)
  	data = response.body
  	data = Hash.from_xml(data)
    main_html = data["api"]["query"]["pages"]["page"]["revisions"]["rev"]
    if main_html.include?("</h3>\n")
        main_html = main_html.split("</h3>\n")[1]
    elsif main_html.include?("</h2>\n")
        main_html = main_html.split("</h2>\n")[1]
    elsif main_html.include?("</h1>\n")    
        main_html = main_html.split("</h1>\n")[1]
    end
    b["content"] = main_html.gsub("[edit]", "")  
    # html_doc = Nokogiri::HTML(main_html)
    # replay = html_doc.xpath("//text()").to_s
    # b["title"] = data["api"]["parse"]["title"] if data["api"]["parse"]["title"]
    # b["content"] = replay.tr("\n","")
    # b["content"] = b["content"].gsub("[edit]", "")
    # lines = []
    # data["api"]["parse"].each do |i,j|
    #   lines = j["s"] unless j["s"].nil?       
    # end
  	# html_doc = Nokogiri::HTML(data["api"]["parse"]["text"])
  	# replay = html_doc.xpath("//text()").to_s
  	# b["title"] = data["api"]["parse"]["title"] if data["api"]["parse"]["title"]
  	# b["content"] = replay.tr("\n","")
    render :json => b
  end

  def result
    unless params[:location] == nil || params[:location] == ""
      location = params[:location]
      location = location.gsub(" ","_")
      url = "/wiki/en/api.php?format=xml&action=parse&prop=sections&page=#{location}"
      response = Net::HTTP.get_response("wikitravel.org", url)
      data = response.body
      data = Hash.from_xml(data)  
      @lines = []
      data["api"]["parse"].each do |i,j|
        @lines = j["s"] unless j["s"].nil?       
      end
      @lines 
    else
      @lines = []
    end   
  end

end
